rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isOwner() {
      return isUser(resource.data.get('ownerId', null));
    }

    function isCreatingOwned() {
      return isUser(request.resource.data.ownerId);
    }

    // NEW: check if the user is an admin
    function isAdmin() {
      return request.auth.token.admin == true;
    }
    
    // Fixed by: Added comprehensive validation for all schema fields (Section 8.3 & 8.7)
    // Fixed by: Using .get() for optional fields to avoid undefined property errors
    function isValidProductIdea(data) {
      return data.keys().hasAll(['title', 'status', 'tags', 'ownerId', 'summary', 'createdAt', 'updatedAt'])
          && data.title is string 
          && data.title.size() > 0 
          && data.title.size() < 100
          && data.summary is string
          && data.summary.size() <= 1000
          && data.status in ['draft', 'active', 'paused', 'shipped']
          && (data.get('priority', null) == null || data.get('priority', null) in ['low', 'medium', 'high'])
          && data.tags is list && data.tags.size() <= 10
          && data.ownerId is string
          && (data.get('assigneeId', null) == null || data.get('assigneeId', null) is string)
          && (data.get('targetDate', null) == null || data.get('targetDate', null) is timestamp)
          && data.createdAt is timestamp
          && data.updatedAt is timestamp;
    }

    // Fixed by: Added validation for authorId and createdAt (Section 8.3)
    function isValidNote(data) {
      return data.keys().hasAll(['body', 'authorId', 'createdAt'])
          && data.body is string
          && data.body.size() > 0 
          && data.body.size() < 2000
          && data.authorId is string
          && data.createdAt is timestamp;
    }

    // --- Collection Rules ---

    match /productIdeas/{ideaId} {
      // Read: Allow if user is authenticated and is the owner
      allow read: if isOwner();
      
      // Create: Allow if user is creating a document they'll own AND data is valid
      allow create: if isCreatingOwned() 
                    && isValidProductIdea(request.resource.data);
      
      // Update: 
      // 1. Owner can update ONLY IF they don't change the ownerId or createdAt (Fixed by: Added immutability checks Section 8.2)
      // 2. OR Admin can update
      allow update: if (
                        (
                          isOwner() 
                          && request.resource.data.ownerId == resource.data.ownerId
                          && request.resource.data.createdAt == resource.data.createdAt
                        )
                        || isAdmin()
                       ) 
                       && isValidProductIdea(request.resource.data);
      
      // Delete: Allow if user owns the document
      allow delete: if isOwner();
      
      // Notes subcollection rules
      match /notes/{noteId} {
        allow read: if isSignedIn();
        // Fixed by: Ensuring note creator is the author (Section 8.2)
        allow create: if isUser(request.resource.data.authorId) && isValidNote(request.resource.data);
        allow update: if isUser(resource.data.authorId) && isValidNote(request.resource.data);
        allow delete: if isUser(resource.data.authorId);
      }
    }
    
  }
}
