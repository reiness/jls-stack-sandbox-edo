rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isOwner() {
      return isUser(resource.data.ownerId);
    }

    function isCreatingOwned() {
      return isUser(request.resource.data.ownerId);
    }
    
    function isValidProductIdea(data) {
      return data.keys().hasAll(['title', 'status', 'tags', 'ownerId'])
          && data.title is string 
          && data.title.size() > 0 
          && data.title.size() < 100
          && data.status in ['draft', 'active', 'paused', 'shipped']
          && data.tags is list && data.tags.size() <= 10
          && data.ownerId is string;
    }

    function isValidNote(data) {
      return data.keys().hasAll(['body', 'authorId'])
          && data.body is string
          && data.body.size() > 0
          && data.body.size() < 2000;
    }

    // --- Collection Rules ---

    match /productIdeas/{ideaId} {
      // Read: Allow if user is authenticated
      allow read: if isSignedIn();
      
      // Create: Allow if user is creating a document they'll own AND data is valid
      allow create: if isCreatingOwned() 
                    && isValidProductIdea(request.resource.data);
      
      // Update: Allow if user owns the document AND data is valid
      allow update: if isOwner() 
                    && isValidProductIdea(request.resource.data);
      
      // Delete: Allow if user owns the document
      allow delete: if isOwner();
      
      // Notes subcollection rules
      match /notes/{noteId} {
        // Read: Allow if user is authenticated
        allow read: if isSignedIn();
        
        // Create: Allow if user is creating a note as the author
        allow create: if isUser(request.resource.data.authorId) && isValidNote(request.resource.data);
        
        // Update: Deny all (append-only)
        allow update: if false;

        // Delete: Allow if user is the author
        allow delete: if isUser(resource.data.authorId);
      }
    }
    
  }
}
